import os

from checks.base import Checker
from problem import Problem, Severity

class AutotoolsChecker(Checker):
    MAGIC = 0xA001

    def _check_string(self, file: str, match: str) -> bool:
        with open(file, "rb") as suspect:
            return match.encode("utf-8") in suspect.read()

    def execute(self, file: str) -> Problem | None:
        basename = os.path.basename(file)
        dodeep = self._text_deep(file)
        if basename.startswith("Makefile") or dodeep:
            if self._check_string(file, "generated by automake"):
                return Problem(Severity.ERROR, "file generated by automake", file, self.MAGIC)
        if basename == "configure" or dodeep:
            if self._check_string(file, "Generated by GNU Autoconf"):
                return Problem(Severity.ERROR, "file generated by autoconf", file, self.MAGIC)
        if basename == "aclocal.m4" or dodeep:
            if self._check_string(file, "generated automatically by aclocal"):
                return Problem(Severity.ERROR, "file generated by aclocal", file, self.MAGIC)
        if basename == "config.h.in":
            return Problem(Severity.WARN, "file probably generated by autoheader", file, self.MAGIC)
        return None
